<!doctype html>
<html>
  <head>
    <title>Mario with squishy-pants.js</title>
    <meta charset="utf-8" />
    <link href="http://netdna.bootstrapcdn.com/twitter-bootstrap/2.3.1/css/bootstrap-combined.min.css" rel="stylesheet">
    <script src="../clock.browser.js"></script>
    <script>
      function event(element, name, callback) {
          if(element.addEventListener) {
              element.addEventListener(name, callback, false);
          } else {
              element.attachEvent('on' + name, callback);
          }
      }

      event(window, 'load', function() {
          var _ = squishy,

              body = _.IO(function() {
                  return document.getElementsByTagName('body')[0];
              }),
              canvas = _.IO(function() {
                  return document.getElementById('canvas');
              }),
              image = _.IO(function() {
                  return document.getElementById('mario');
              }),

              keyboard = _.Stream(
                  function(next, done) {
                      event(body.unsafePerform(), 'keydown', function(e) {
                          var code = e.keyCode;
                          if (code >= 37 && code <= 40) {
                              next({  
                                x : code === 37 ? -1 : code === 39 ? 1 : 0,
                                y : code === 40 ? -1 : code === 38 ? 1 : 0
                              });
                          }
                      });
                      event(body.unsafePerform(), 'keyup', function(e) {                        
                          next({  
                            x : 0,
                            y : 0
                          });
                      })
                  }
              ),


              mario = {
                      x: 0,
                      y: 0,
                      vx: 0,
                      vy: 0,
                      dir: 'right'
              },
              jump = _.curry(function(dir, mario) {
                  var lensVy = _.Lens.objectLens('vy').run(mario);
                  return lensVy.set((dir.y > 0 && mario.y === 0) ? mario.vy + 6 : mario.vy);
              }),
              gravity = _.curry(function(t, mario) {
                  var lensVy = _.Lens.objectLens('vy').run(mario);
                  return lensVy.set(mario.y > 0 ? mario.vy - 0.5 : mario.vy);
              }),
              physics = _.curry(function(t, mario) {
                  var lensX = _.Lens.objectLens('x').run(mario),
                      mX = lensX.set(Math.max(0, Math.min(600 - 32, mario.x + (t * mario.vx)))),

                      lensY = _.Lens.objectLens('y').run(mX),
                      mY = lensY.set(Math.max(0, mario.y + t * mario.vy));
                  
                  return mY;
              }),
              walk = _.curry(function(dir, mario) {
                  var lensVx = _.Lens.objectLens('vx').run(mario),
                      mVx = lensVx.set(dir.x + (mario.vx / 10)),

                      lensDir = _.Lens.objectLens('dir').run(mVx),
                      mDir = lensDir.set(dir.x < 0 ? 'left' : dir.x > 0 ? 'right' : lensDir.get());

                  return mDir;
              }),
              step = function(mario, t, dir) {
                  var time = t || 0,
                      direction = dir || {x: 0, y: 0},

                      p = physics(time),
                      w = walk(direction),
                      g = gravity(time),
                      j = jump(direction);

                  return _.compose(j, _.compose(g, _.compose(w, p)))(mario);
              },
              render = _.curry(function(image, mario) {
                  var verb = mario.y > 0 ? 'jump' :
                             Math.abs(mario.vx) > 0.05 ? 'walk' :
                                              'stand',

                      src = 'imgs/mario/' + verb + '/' + mario.dir + '.gif',
                      node = image.unsafePerform();

                  /* TODO : Abstract this away, very bad */
                  if (src !== node.relativeSrc) {
                      node.src = src;
                      node.relativeSrc = src;
                  }
                  node.style.left = mario.x + 'px';
                  node.style.top = 400 - (mario.y + 130) + 'px';   
              }),
              draw = render(image),
              optional = function(r) {
                  return function() {
                      return r.f ? r.f.apply(null, _.rest(arguments)) : null;
                  }
              };

          // Merge two streams together to produce a tuple of last know values.
          _.Stream.prototype.andWith = function(a) {
              var env = this;

              return _.Stream(
                  function(next, done) {
                      var left,
                          right,
                          end = _.once(done);

                      env.fork(
                          function(a) {
                              left = a;
                              next(_.Tuple2(a, right));
                          },
                          end
                      );

                      a.fork(
                          function(a) {
                              right = a;
                              next(_.Tuple2(left, a));
                          },
                          end
                      );
                  }
              );
          };

          _.tick().map(
              function(a, b) {
                  return 2;
              }
          ).andWith(keyboard).scan(
              mario,
              function(a, b) {
                  return step(a, b._1, b._2);
              }
          ).fork(
              draw
          );
      });

    </script>
    <link href='http://fonts.googleapis.com/css?family=Ubuntu+Mono' rel='stylesheet' type='text/css'>
    <style type="text/css">
        #canvas {
            margin: 0 0 0 80px;
            width: 600px;
            height: 400px;
            background: #00d2dd;
            background: -moz-linear-gradient(top,  #00d2dd 75%, #8fc800 75%);
            background: -webkit-gradient(linear, left top, left bottom, color-stop(75%,#00d2dd), color-stop(75%,#8fc800));
            background: -webkit-linear-gradient(top,  #00d2dd 75%,#8fc800 75%);
            background: linear-gradient(to bottom,  #00d2dd 75%,#8fc800 75%);
        }
        #mario {
            position: relative;
            -webkit-transform: translate3d(0, 0, 0);
        }
    </style>
  </head>
  <body>
    <div class="container">
      <div class="row">
        <div class="span8 offset2">
          <h1>Mario using <a href="https://github.com/SimonRichardson/squishy-pants">squishy-pants.js</a></h1>
          <hr />
          <div id="canvas">
              <img id="mario" />
          </div>
        </div>
      </div>
    </div>
  </body>
</html>
